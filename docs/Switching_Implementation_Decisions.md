# РЕШЕНИЯ ПО РЕАЛИЗАЦИИ SWITCHING LEMMA
**Дата:** 22 октября 2025
**Статус:** Утверждено, начинаем реализацию
**Спринт:** PR-1 (одиночный литерал)

---

## ПРИНЯТЫЕ РЕШЕНИЯ

### ✅ Q1: Подход - C. Гибридный

**Решение:**
- **Сейчас:** Конструктивный подход для d=2 (DNF/CNF)
- **Потом:** Вероятностный абстрактный слой для общего d
- **НЕ делаем:** Measure theory на первом этапе

**Обоснование:**
- Быстро снимает аксиомы для depth-2
- Проверяет инфраструктуру PDT/PartialCertificate
- Открывает античекер для тестов на игрушечных экземплярах
- Не закапываемся в measure-theory раньше времени

### ✅ Q2: Ресурсы

**Литература:**
- ✅ Håstad thesis (1986)
- ✅ Jukna "Boolean Function Complexity"
- ✅ Arora-Barak (глава 14)
- ✅ Servedio-Tan (2018) для multi-switching

**Mathlib:**
- ✅ НЕ требуются: Probability, MeasureTheory (на первом этапе)
- ✅ Нужны: Fin, Finset, списки, базовые неравенства
- ✅ Позже: Nat.log2, логарифмические оценки

**Контакты:**
- ✅ Zulip: #mathlib, #lean4, #complexity

### ✅ Q3: ResidualDTDepth - B. Конструктивная верхняя оценка

**Решение:**
```lean
def compileResidualToDT (f : BitVec n → Bool) (β : Subcube n) : PDT n := ...

def ResidualDTDepth (f : BitVec n → Bool) (β : Subcube n) : Nat :=
  PDT.depth (compileResidualToDT f β)
```

**Обоснование:**
- Дает рабочее определение сразу
- Леммы монотонности легко доказать
- Пригодится для малых DNF и комбинирования
- Позже можно улучшить до минимальной глубины через Nat.find

### ✅ Q4: Малые конкретные примеры - ДА

**Решение:**
- Начинаем с n=2,3
- Проверяем на конкретных примерах
- Отлаживаем инфраструктуру (selectors, errU, leaves/realize)

### ✅ Q5: Завершить одиночные литералы - ДА

**Решение:**
- Это первый PR (PR-1)
- Быстрая победа (1 неделя)
- Образец стиля доказательств

---

## БЭКЛОГ (6 PR)

### PR-1: Завершить partial_shrinkage_single_literal ⭐ ТЕКУЩИЙ
**Срок:** 1 неделя
**Файл:** `ThirdPartyFacts/Depth2_Constructive.lean`

**Задачи:**
- [x] Построить дерево `PDT.node i (PDT.leaf β0) (PDT.leaf β1)`
- [ ] Закрыть `selectors_sub`
- [ ] Доказать `errU = 0`
- [ ] Добавить helper леммы для PDT (depth, leaves)
- [ ] Написать тесты для n=2,3

**Exit criteria:**
- ✅ Теорема закрыта (no sorry)
- ✅ Тесты проходят для n=2,3
- ✅ Все helper леммы имеют @[simp]

---

### PR-2: Одиночный терм (конъюнкция)
**Срок:** 1 неделя
**Файл:** `ThirdPartyFacts/Depth2_Constructive.lean`

**Задачи:**
- [ ] Рекурсивное ветвление по списку переменных
- [ ] Композиция подкубов (Subcube.fix)
- [ ] Доказать ε = 0
- [ ] depthBound ≤ k (k = число переменных в терме)

**Зависимости:** PR-1

**Exit criteria:**
- ✅ Лемма `partial_shrinkage_single_term` закрыта
- ✅ Тесты для термов длины 1,2,3

---

### PR-3: Одиночная клауза (дизъюнкция)
**Срок:** 1 неделя
**Файл:** `ThirdPartyFacts/Depth2_Constructive.lean`

**Задачи:**
- [ ] Зеркально терму, ранний выход на true
- [ ] depthBound ≤ k
- [ ] ε = 0

**Зависимости:** PR-2

**Exit criteria:**
- ✅ Лемма `partial_shrinkage_single_clause` закрыта
- ✅ Переиспользование лемм из PR-2

---

### PR-4: Малые DNF (M ≤ 4)
**Срок:** 2 недели
**Файл:** `ThirdPartyFacts/Depth2_Constructive.lean`

**Задачи:**
- [ ] Склейка PartialDT (введение комбинаторов)
- [ ] Оценка глубины композиции
- [ ] Явный перебор для M=1,2,3,4
- [ ] ε = 0 для малых формул

**Зависимости:** PR-2, PR-3

**Exit criteria:**
- ✅ Лемма `partial_shrinkage_small_dnf` закрыта
- ✅ Комбинаторы PartialDT.bind/glue

---

### PR-5: Depth-2 общий случай (конструктивно)
**Срок:** 3-4 недели
**Файлы:** `Depth2_Switching_Spec.lean`, `Depth2_Constructive.lean`

**Задачи:**
- [ ] Индукция по M (размер формулы)
- [ ] Компоновка деревьев
- [ ] depthBound ≤ (log M)²
- [ ] ε ≤ 1/(n+2)

**Зависимости:** PR-1..4, ResidualDTDepth

**Exit criteria:**
- ✅ Теорема `partial_shrinkage_for_AC0_depth2` закрыта
- ✅ Снимает аксиому для d=2

---

### PR-6: Подготовка к общему d (абстракция)
**Срок:** 2-3 недели
**Файлы:** `ThirdPartyFacts/Facts_Switching.lean`

**Задачи:**
- [ ] Интерфейс "случайной рестрикции" (без measure theory)
- [ ] Параметры p, "событие хороших рестрикций"
- [ ] Комбинаторная верхняя оценка
- [ ] Абстрактная форма вероятностного утверждения

**Зависимости:** Depth-2

**Exit criteria:**
- ✅ Интерфейс готов для замены на Mathlib.Probability
- ✅ Не меняет PartialCertificate

---

## ВРЕМЕННАЯ ОЦЕНКА

| Фаза | Срок | Результат |
|------|------|-----------|
| **PR-1** (литерал) | 1 неделя | Образец доказательств ✅ |
| **PR-2** (терм) | 1 неделя | Композиция подкубов |
| **PR-3** (клауза) | 1 неделя | Симметрия терм/клауза |
| **PR-4** (малые DNF) | 2 недели | Комбинаторы PartialDT |
| **PR-5** (depth-2) | 3-4 недели | Снятие аксиомы для d=2 ✅ |
| **PR-6** (абстракция) | 2-3 недели | Готовность к общему d |
| **ИТОГО** | **2-3 месяца** | Depth-2 полностью без аксиом |

**Затем:**
- Обобщение на произвольный d: 2-3 месяца
- Локальные схемы и оракулы: 1 месяц

**ОБЩЕЕ ВРЕМЯ:** 5-7 месяцев до снятия всех аксиом switching

---

## ДОПОЛНИТЕЛЬНЫЙ КОНТЕКСТ

### Классические результаты (опора)

**Håstad (1987):**
- DNF формула ширины w
- Случайное ограничение с параметром p
- Вероятность глубины DT ≥ t: ≤ (C·p·w)^t

**Razborov (1993), Beame (1994):**
- Упрощенные доказательства
- Те же оценки

**Arora-Barak глава 14:**
- Обзор switching lemma
- Приложения к AC⁰

**Показатель сжимаемости AC⁰:**
- ≤ 1/2 (глубина DT растет сублинейно)
- Это именно оценка для partial_shrinkage_for_AC0

### Стратегия формализации

1. **Не формализуем вероятности сразу**
   - Используем детерминированное "существует хорошее ρ"
   - Оценка вероятности → epsilon в PartialCertificate

2. **Опираемся на бумажные доказательства**
   - Håstad дает все нужные константы
   - Можно адаптировать упрощенные версии (Razborov/Beame)

3. **Поэтапная формализация**
   - PR-1..5: конструктивные случаи
   - PR-6: абстрактный слой
   - Потом: вероятностная версия (если нужно)

---

## ГРАБЛИ И НЮАНСЫ

### 1. selectors и листья
**Проблема:** selectors f должны быть подмассивом листьев ствола

**Решение:**
- Заведите @[simp] для включений в PDT.leaves
- Иначе selectors_sub - ручная возня

### 2. errU нулевая на полном разбиении
**Проблема:** Нужно доказывать для каждого случая

**Решение:**
- Докажите вспомогательную: если selectors f покрывают пространство по переменной без пересечений, то errU = 0
- Это закроет PR-1..3 в одну строку

### 3. Склейка PartialDT
**Проблема:** Композиция деревьев сложна

**Решение:**
- Введите комбинаторы PartialDT.bind/glue
- Леммы про оценку глубины и хвостов при композиции

### 4. Именование и стиль
**Решение:**
- Модуль PDT/Sugar.lean с леммами-сахаром
- depth_node_succ, leaves_node, leaf_mem_leaves, realize_leaf

### 5. Логи и неравенства
**Решение:**
- Для depth-2 можно без точного log₂
- К моменту AC⁰-обобщения подключить Nat.log2/Real.log

---

## ГОТОВЫЕ ЗАГОТОВКИ

### Леммы для PDT
```lean
@[simp] lemma PDT.depth_leaf (β : Subcube n) :
  PDT.depth (PDT.leaf β) = 0 := rfl

lemma PDT.depth_node_le_one (t : PDT n) :
  PDT.depth (PDT.node i (PDT.leaf β0) (PDT.leaf β1)) ≤ 1 := by
  simpa using Nat.le_of_eq (by simp [PDT.depth])

@[simp] lemma PDT.leaves_node :
  PDT.leaves (PDT.node i L R) = PDT.leaves L ∪ PDT.leaves R := by
  ...
```

### Нулевая ошибка
```lean
lemma errU_literal_zero (i : Fin n) :
  let f : BitVec n → Bool := singleLiteral n i
  errU f [restrictToFalse n i, restrictToTrue n i] = 0 := by
  ...
```

### Композиция подкубов
```lean
def Subcube.fix (β : Subcube n) (i : Fin n) (b : Bool) : Subcube n := ...
lemma fix_monotone : β ≤ β.fix i b := ...
lemma eval_on_fix (x : BitVec n) :
  x ∈ β.fix i b ↔ (x ∈ β ∧ x[i] = b) := ...
```

---

## СЛЕДУЮЩИЕ ШАГИ

### Прямо сейчас (PR-1):
1. ✅ Создать этот summary
2. 🔄 Добавить helper леммы для PDT
3. 🔄 Завершить partial_shrinkage_single_literal
4. 🔄 Написать тесты для n=2,3
5. 🔄 Коммит и push

### После PR-1:
- PR-2: Одиночный терм (1 неделя)
- PR-3: Одиночная клауза (1 неделя)
- PR-4: Малые DNF (2 недели)

---

**Создано:** 22 октября 2025
**Статус:** ✅ Решения приняты, начинаем PR-1
**Следующий шаг:** Реализация helper лемм для PDT
